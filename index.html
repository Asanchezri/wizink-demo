<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>WiZink Aura | Enterprise AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #020617; --card: rgba(30, 41, 59, 0.7); --primary: #7c3aed; --accent: #ec4899; --text: #f8fafc; --border: rgba(255,255,255,0.1); }
        * { box-sizing: border-box; }
        
        body { 
            margin: 0; font-family: 'Inter', sans-serif; 
            background: radial-gradient(circle at top right, #312e81, #0f172a);
            color: var(--text); height: 100vh; display: flex; overflow: hidden; 
        }

        /* --- SIDEBAR --- */
        .sidebar { width: 320px; background: rgba(15, 23, 42, 0.95); border-right: 1px solid var(--border); display: flex; flex-direction: column; backdrop-filter: blur(10px); }
        .header { padding: 25px; border-bottom: 1px solid var(--border); font-size: 1.1rem; font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; }
        .logo-dot { width: 10px; height: 10px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); }
        
        .client-list { flex: 1; overflow-y: auto; padding: 10px; }
        .client-card { 
            padding: 15px; margin-bottom: 8px; border-radius: 12px;
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 12px;
            border: 1px solid transparent;
        }
        .client-card:hover { background: rgba(255,255,255,0.05); }
        .client-card.active { background: linear-gradient(90deg, rgba(124, 58, 237, 0.2), transparent); border: 1px solid var(--primary); }
        
        .avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid #334155; }
        .info h4 { margin: 0; font-size: 0.9rem; font-weight: 600; }
        .info p { margin: 2px 0 0; font-size: 0.75rem; color: #94a3b8; }
        .badge { font-size: 0.65rem; padding: 4px 8px; border-radius: 20px; font-weight: bold; letter-spacing: 0.5px; text-transform: uppercase; }

        /* --- MAIN STAGE --- */
        .stage { flex: 1; padding: 40px; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .stage::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: url('https://grainy-gradients.vercel.app/noise.svg'); opacity: 0.05; pointer-events: none;
        }

        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #475569; opacity: 0.5; }

        /* --- WORKSPACE --- */
        .workspace { display: none; height: 100%; grid-template-columns: 1.2fr 0.8fr; gap: 40px; align-items: center; max-width: 1400px; margin: 0 auto; z-index: 10; }
        
        /* AGENT PANEL */
        .agent-container { position: relative; border-radius: 24px; overflow: hidden; border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .agent-video { width: 100%; display: block; aspect-ratio: 16/9; object-fit: cover; filter: contrast(1.1) saturate(1.1); }
        
        .overlay-ui { 
            position: absolute; inset: 0; background: linear-gradient(to top, #020617 10%, transparent 60%); 
            padding: 30px; display: flex; flex-direction: column; justify-content: flex-end;
        }
        
        .script-box { 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); 
            padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);
            color: #e2e8f0; font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px;
            min-height: 80px; display: flex; align-items: center;
        }

        /* WAVEFORM */
        .wave-container { display: flex; align-items: center; gap: 15px; }
        .wave-bars { display: flex; gap: 4px; height: 30px; align-items: center; }
        .bar { width: 4px; height: 4px; background: var(--accent); border-radius: 4px; transition: 0.1s; }
        .speaking .bar { animation: equalize 0.5s infinite; }
        @keyframes equalize { 0% { height: 4px; } 50% { height: 25px; } 100% { height: 4px; } }

        /* DATA PANEL */
        .data-panel { display: flex; flex-direction: column; gap: 20px; }
        .client-header h1 { margin: 0; font-size: 2.5rem; letter-spacing: -1px; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .client-header p { color: var(--accent); font-weight: 500; font-size: 1.1rem; margin-top: 5px; }

        .plan-card { 
            background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 30px;
            backdrop-filter: blur(20px); transition: 0.5s; opacity: 0.5; transform: translateY(20px);
        }
        .plan-card.visible { opacity: 1; transform: translateY(0); }

        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
        .kpi { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .kpi-val { font-size: 1.8rem; font-weight: 800; color: #10b981; }
        .kpi-label { font-size: 0.75rem; text-transform: uppercase; color: #64748b; letter-spacing: 1px; margin-top: 5px; display: block;}

        .btn-magic {
            width: 100%; padding: 20px; border-radius: 16px; border: none; font-size: 1rem; font-weight: 800; cursor: pointer;
            background: linear-gradient(135deg, var(--primary), var(--accent)); color: white;
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.4); transition: 0.3s; margin-top: auto;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-magic:hover { transform: scale(1.02); box-shadow: 0 0 30px rgba(236, 72, 153, 0.6); }
        .btn-magic i { font-style: normal; font-size: 1.2rem; }
        
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(236, 72, 153, 0); } 100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); } }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">
            <div class="logo-dot"></div> WiZink Aura <span style="font-weight:300; opacity:0.5; margin-left:5px;">Ent.</span>
        </div>
        <div class="client-list" id="clientList"></div>
    </div>

    <div class="stage">
        <div id="emptyState" class="empty-state">
            <div style="font-size:3rem; margin-bottom:10px; opacity:0.5;">üëà</div>
            <h3>Selecciona un cliente</h3>
        </div>

        <div id="workspace" class="workspace">
            
            <div class="agent-container">
                <video id="agentVideo" class="agent-video" loop playsinline src="https://videos.pexels.com/video-files/8353841/8353841-hd_1920_1080_25fps.mp4"></video>
                <div class="overlay-ui">
                    <div class="script-box" id="scriptText">...</div>
                    <div class="wave-container">
                        <div style="font-size:0.8rem; font-weight:700; color:var(--accent); text-transform:uppercase;">Aura Voice</div>
                        <div class="wave-bars" id="waves">
                            <div class="bar" style="animation-delay:0s"></div>
                            <div class="bar" style="animation-delay:0.1s"></div>
                            <div class="bar" style="animation-delay:0.2s"></div>
                            <div class="bar" style="animation-delay:0.3s"></div>
                            <div class="bar" style="animation-delay:0.1s"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="data-panel">
                <div class="client-header">
                    <h1 id="clientName">Nombre Cliente</h1>
                    <p id="clientIssue">Motivo del an√°lisis...</p>
                </div>

                <div class="plan-card" id="planCard">
                    <h3 style="color:var(--primary); margin-top:0; font-size:1.2rem;">PROPUESTA GENERADA</h3>
                    <ul id="planSteps" style="padding-left:20px; color:#cbd5e1; line-height:1.8;">
                        <li>Esperando an√°lisis de IA...</li>
                    </ul>
                    
                    <div class="kpi-grid">
                        <div class="kpi">
                            <span class="kpi-val" id="scoreImpact">--</span>
                            <span class="kpi-label">Impacto Score</span>
                        </div>
                        <div class="kpi">
                            <span class="kpi-val">94%</span>
                            <span class="kpi-label">Conversi√≥n</span>
                        </div>
                    </div>
                </div>

                <button id="btnAnalyze" class="btn-magic pulse" onclick="runAnalysis()">
                    <i>‚ú®</i> GENERAR ESTRATEGIA
                </button>
                <button id="btnSend" class="btn-magic" style="display:none; background:#10b981; box-shadow:none;" onclick="sendEmail()">
                    <i>üöÄ</i> ENVIAR A APP M√ìVIL
                </button>
            </div>
        </div>
    </div>

    <script>
        let clients = [];
        let selectedId = null;
        let currentData = null;

        setInterval(loadClients, 2000);

        async function loadClients() {
            try {
                const res = await fetch('/api/clientes');
                clients = await res.json();
                renderList();
            } catch(e) { console.log("Conectando..."); }
        }

        function renderList() {
            const list = document.getElementById('clientList');
            list.innerHTML = clients.map(c => `
                <div class="client-card ${selectedId === c.id ? 'active' : ''}" onclick="selectClient(${c.id})">
                    <img src="${c.avatar}" class="avatar">
                    <div class="info" style="flex:1;">
                        <h4>${c.nombre}</h4>
                        <p>${c.motivo}</p>
                    </div>
                    <span class="badge" style="background:${getBadgeColor(c.segmento)}">${c.segmento.split(' ')[0]}</span>
                    ${c.estado.includes('CERRADO') ? '‚úÖ' : ''}
                </div>
            `).join('');

            // Check status update real-time
            if(selectedId) {
                const c = clients.find(x => x.id === selectedId);
                if(c.estado.includes("CERRADO")) {
                    const btn = document.getElementById('btnSend');
                    btn.style.background = "#334155";
                    btn.innerHTML = "<i>üîí</i> OFERTA CERRADA";
                    btn.disabled = true;
                }
            }
        }

        function getBadgeColor(seg) {
            if(seg.includes('VIP')) return '#eab308; color:black';
            if(seg.includes('Riesgo')) return '#ef4444; color:white';
            return '#3b82f6; color:white';
        }

        function selectClient(id) {
            selectedId = id;
            const c = clients.find(x => x.id === id);
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('workspace').style.display = 'grid';
            document.getElementById('clientName').innerText = c.nombre;
            document.getElementById('clientIssue').innerText = c.motivo;
            
            // Reset
            document.getElementById('planCard').classList.remove('visible');
            document.getElementById('btnAnalyze').style.display = "flex";
            document.getElementById('btnSend').style.display = "none";
            document.getElementById('scriptText').innerText = "Sistema listo. Esperando comando.";
            
            renderList();
        }

        async function runAnalysis() {
            const btn = document.getElementById('btnAnalyze');
            btn.innerHTML = "<i>‚öôÔ∏è</i> PROCESANDO...";
            btn.classList.remove('pulse');
            
            const res = await fetch('/api/analizar', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: selectedId })
            });
            const json = await res.json();
            currentData = json.data;

            // Update UI
            document.getElementById('planSteps').innerHTML = `
                <li>${currentData.plan.accion1}</li>
                <li>${currentData.plan.accion2}</li>
            `;
            document.getElementById('scoreImpact').innerText = currentData.impacto;
            document.getElementById('planCard').classList.add('visible');

            // Play Video & TTS
            playAgent(currentData.videoScript);

            btn.style.display = "none";
            document.getElementById('btnSend').style.display = "flex";
        }

        function playAgent(text) {
            const video = document.getElementById('agentVideo');
            const waves = document.getElementById('waves');
            const scriptBox = document.getElementById('scriptText');
            
            scriptBox.innerText = text;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'es-ES';
            u.rate = 1.1; // Un poco m√°s r√°pido y natural
            
            u.onstart = () => { video.play(); waves.classList.add('speaking'); };
            u.onend = () => { video.pause(); waves.classList.remove('speaking'); };
            window.speechSynthesis.speak(u);
        }

        async function sendEmail() {
            const c = clients.find(x => x.id === selectedId);
            const btn = document.getElementById('btnSend');
            btn.innerHTML = "<i>üì®</i> ENVIANDO...";
            
            await fetch('/api/enviar', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    id: c.id, 
                    to: c.email, 
                    subject: `WiZink: Tienes una nueva oportunidad`, 
                    body: currentData.emailHTML
                })
            });
            
            alert(`üì® Propuesta enviada al dispositivo de ${c.nombre}.`);
            btn.innerHTML = "<i>‚è≥</i> ESPERANDO CLIENTE...";
            btn.style.background = "#475569";
        }
    </script>
</body>
</html>